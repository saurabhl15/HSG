<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><?= conferenceName ?> • <?= churchName ?></title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --accent:#111827; --border:#e5e7eb;
      --ok-bg:#ecfdf5; --ok-bd:#a7f3d0; --bad-bg:#fef2f2; --bad-bd:#fecaca;
      --tab:#f1f5f9; --tab-active:#111827; --tab-ink:#0f172a; --tab-active-ink:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);}
    .shell{max-width:980px;margin:0 auto;padding:16px;}
    .hero{position:sticky;top:0;z-index:3;background:linear-gradient(135deg,#eef2ff,#e0f2fe);border-bottom:1px solid var(--border);}
    .hero-inner{max-width:980px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center;}
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .status-pill{margin-left:auto;font-size:13px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:#fff;display:flex;align-items:center;gap:8px;white-space:nowrap;}
    .status-pill .dot{width:10px;height:10px;border-radius:50%;}
    .dot.inactive{background:#ef4444}.dot.active{background:#10b981}
    .tabs{display:flex;gap:8px;padding:12px 16px 8px;border-bottom:1px solid var(--border);}
    .tab{padding:8px 12px;border-radius:8px;background:var(--tab);color:var(--tab-ink);cursor:pointer;user-select:none}
    .tab.active{background:var(--tab-active);color:var(--tab-active-ink);}
    .wrap{padding:12px 16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px}
    label{font-size:12px;color:var(--muted);letter-spacing:.2px}
    input,select,button{padding:10px 12px;font-size:14px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input::placeholder{color:#9aa4b2}
    button{cursor:pointer}
    .btn{background:#fff}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.checked{background:#10b981;color:#fff;border-color:#10b981}
    .btn.food-paid{background:#10b981;color:#fff;border-color:#10b981}
    .band-blue{background:#3b82f6;color:#fff;padding:4px 12px;border-radius:6px;font-weight:600}
    .band-green{background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-weight:600}
    .band-yellow{background:#eab308;color:#fff;padding:4px 12px;border-radius:6px;font-weight:600}
    .stack{display:flex;gap:8px;align-items:center}
    .status{padding:10px;border-radius:10px;margin-top:8px}
    .status.ok{background:var(--ok-bg);border:1px solid var(--ok-bd)}
    .status.bad{background:var(--bad-bg);border:1px solid var(--bad-bd)}
    .kpi{font-weight:800;font-size:20px}
    .section-title{margin:0 0 8px 0;font-size:16px}
    .hint{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:8px}
    .tr{display:grid;grid-template-columns:1.2fr .9fr .9fr .8fr auto;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);padding:8px;border-radius:8px}
    .small{font-size:12px;color:var(--muted)}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .required{color:#ef4444}
  </style>
</head>
<body>
  <div class="hero">
    <div class="hero-inner">
      <div class="brand"><?= conferenceName ?> • <?= churchName ?></div>
      <div id="statusPill" class="status-pill">
        <span id="statusDot" class="dot active"></span>
        <span id="statusText">Registration: Active</span>
      </div>
    </div>
    <div class="tabs">
      <div class="tab" id="tab-registration">Registration</div>
      <div class="tab" id="tab-spot">Admin</div>
      <div class="tab" id="tab-stats">Stats</div>
    </div>
  </div>

  <div class="shell wrap">

    <!-- Registration -->
    <div id="registration-panel" class="card">
      <h3 class="section-title">Registration</h3>
      <div class="field" style="width:100%;">
        <label>Scan QR / paste code</label>
        <input id="scanInput" autocomplete="off" placeholder="Focus here and scan…" title="Place cursor here and scan the attendee code" />
      </div>
      <div id="result" class="card hidden"></div>
      
      <!-- Lookup section -->
      <div id="registration-lookup" class="card" style="margin-top:12px;">
        <h4 style="margin:0 0 6px 0">Lookup Attendee</h4>
        <div class="row">
          <div class="field" style="flex:1 1 260px">
            <label>Name / Phone / Email / QR Code</label>
            <input id="registration_lk_q" placeholder="Type part of name, phone, email, or scan QR">
          </div>
          <button class="btn" onclick="registrationLookup()" title="Find existing records">Search</button>
        </div>
        <div id="registration_lk_results" class="table"></div>
      </div>
    </div>

    <!-- Admin -->
    <div id="spot-panel" class="card" style="display:none;">
      <h3 class="section-title">Spot Registration</h3>
      <div class="row">
        <div class="field"><label>Name <span class="required">*</span></label><input id="sr_name" placeholder="Full name" required></div>
        <div class="field" style="max-width:160px"><label>Gender</label><input id="sr_gender" placeholder="Male / Female"></div>
        <div class="field" style="max-width:120px"><label>Age</label><input id="sr_age" placeholder="Years"></div>
        <div class="field"><label>Phone</label><input id="sr_phone" placeholder="+91…"></div>
        <div class="field"><label>Email</label><input id="sr_email" placeholder="name@example.com"></div>
        <div class="field"><label>Type of Member</label><input id="sr_type" placeholder="Member / Visitor…"></div>
        <div class="field"><label>City</label><input id="sr_city" placeholder="City"></div>
        <div class="field"><label>State</label><input id="sr_state" placeholder="State"></div>
        <div class="field"><label>Country</label><input id="sr_country" placeholder="Country"></div>
      </div>
      <div class="hint">ID and Aggregate will auto-fill via formulas copied from the previous row. Name is required.</div>
      <div class="stack" style="margin-top:8px">
        <button class="btn primary" onclick="submitSpotReg(true)" title="Add the person and mark them as registered">Add and Register</button>
        <button class="btn" onclick="submitSpotReg(false)" title="Add only; do not register yet">Add Only</button>
        <button class="btn ghost" onclick="clearSpotForm()" title="Clear all form fields">Clear Form</button>
      </div>
      <div id="spot-result" class="status ok hidden"></div>

      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <h4 style="margin:0 0 6px 0">Lookup</h4>
      <div class="row">
        <div class="field" style="flex:1 1 260px">
          <label>Name / Phone / Email</label>
          <input id="lk_q" placeholder="Type part of name, phone, or email">
        </div>
        <button class="btn" onclick="lookup()" title="Find existing records">Search</button>
      </div>
      <div id="lk_results" class="table"></div>
    </div>

    <!-- Stats -->
    <div id="stats-panel" class="card" style="display:none;">
      <h3 class="section-title">Stats</h3>
      <div class="stack">
        <button class="btn" onclick="refreshStats()" title="Fetch latest counts">Refresh</button>
      </div>
      <div id="stats" class="row" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
  // Tabs
  const tabs = ['registration','spot','stats'];
  document.getElementById('tab-registration').onclick=()=>showTab('registration');
  document.getElementById('tab-spot').onclick=()=>showTab('spot');
  document.getElementById('tab-stats').onclick=()=>showTab('stats');

  function showTab(which){
    tabs.forEach(t=>{
      const active = (t===which);
      document.getElementById('tab-'+t).classList.toggle('active',active);
      document.getElementById(t+'-panel').style.display = active ? '' : 'none';
    });
    
    // Auto-refresh stats when switching to stats tab
    if (which === 'stats') {
      refreshStats();
    }
  }

  // Registration flow
  const scanEl = document.getElementById('scanInput');
  scanEl.addEventListener('keydown',e=>{ if(e.key==='Enter') handleScan(); });
  
  // Add Enter key support for lookup inputs
  document.getElementById('registration_lk_q').addEventListener('keydown',e=>{ if(e.key==='Enter') registrationLookup(); });
  document.getElementById('lk_q').addEventListener('keydown',e=>{ if(e.key==='Enter') lookup(); });
  function handleScan(){
    const text=(scanEl.value||'').trim();
    if(!text){ return; }
    
    // Show loading state
    const el=document.getElementById('result');
    el.classList.remove('hidden');
    el.innerHTML=`<div class="status">Registering...</div>`;
    
    google.script.run
      .withSuccessHandler(handleRegistrationResult)
      .withFailureHandler(err=>{
        el.innerHTML=`<div class="status bad">Error: ${err}</div>`;
      })
      .registerByAggregate(text);
  }
  
  function handleRegistrationResult(resp){
    const el=document.getElementById('result');
    if(resp.status==='NOT_FOUND'){ 
      el.innerHTML=`<div class="status bad">QR not found. Try lookup below.</div>`; 
      return; 
    }
    if(resp.status!=='REGISTERED'){ 
      el.innerHTML=`<div class="status bad">Error: ${resp.message||resp.status}</div>`; 
      return; 
    }
    
    // Success - show confirmation with band color and undo option
    const bandColor = resp.bandColor || 'blue';
    const bandColorText = bandColor === 'yellow' ? 'YELLOW' : (bandColor === 'green' ? 'GREEN' : 'BLUE');
    
    el.innerHTML=`
      <div class="status ok">
        <div style="margin-bottom:8px">✓ Registered: <strong>${resp.attendee.Name}</strong></div>
        <div style="margin-bottom:8px">Please issue a <span class="band-${bandColor}">${bandColorText}</span> color band</div>
        <button class="btn ghost" onclick="undoRegistration('${resp.attendee.Aggregate}')" style="margin-top:4px">Undo Registration</button>
      </div>
    `;
    scanEl.value=''; 
    scanEl.focus();
  }
  function undoRegistration(agg){
    if(!confirm('Undo registration for this attendee?')) return;
    
    const el=document.getElementById('result');
    el.innerHTML=`<div class="status">Undoing registration...</div>`;
    
    // First lookup the attendee to get the row
    google.script.run.withSuccessHandler(resp => {
      if(resp && resp.status === 'FOUND' && resp.attendee && resp.attendee._row) {
        // Then toggle the registration
        google.script.run.withSuccessHandler(r=>{
          el.innerHTML=`<div class="status ok">Registration undone for: ${r.Name || 'Unknown'}</div>`;
          setTimeout(() => {
            el.classList.add('hidden');
            scanEl.focus();
          }, 2000);
        }).withFailureHandler(err=>{
          el.innerHTML=`<div class="status bad">Error: ${err}</div>`;
        }).toggleRegistration(resp.attendee._row);
      } else {
        el.innerHTML=`<div class="status bad">Could not find attendee to undo</div>`;
      }
    }).withFailureHandler(err=>{
      el.innerHTML=`<div class="status bad">Error: ${err}</div>`;
    }).lookupByAggregate(agg);
  }
  
  function togglePayment(row){
    google.script.run.withSuccessHandler(()=>handleScan()).withFailureHandler(err=>alert(err)).togglePaidForFood(row,null);
  }
  function markOptForFood(row){
    google.script.run.withSuccessHandler(()=>handleScan()).withFailureHandler(err=>alert(err)).togglePaidForFood(row,true);
  }
  
  // Registration lookup function
  function registrationLookup(){
    const q=(document.getElementById('registration_lk_q').value||'').trim();
    if(!q){ document.getElementById('registration_lk_results').innerHTML=''; return; }
    
    // First try QR code lookup if it looks like a QR code (contains VOA)
    if(q.includes('VOA')) {
      // Show loading state for registration
      const el=document.getElementById('result');
      el.classList.remove('hidden');
      el.innerHTML=`<div class="status">Registering...</div>`;
      
      google.script.run.withSuccessHandler(resp=>{
        if(resp.status==='FOUND') {
          // Found via QR, auto register and get band color
          google.script.run.withSuccessHandler(registerResp=>{
            handleRegistrationResult(registerResp);
            document.getElementById('registration_lk_q').value = '';
          }).withFailureHandler(err=>{
            document.getElementById('result').innerHTML=`<div class="status bad">Error: ${err}</div>`;
          }).registerByAggregate(q);
          return;
        }
        // QR not found, fall back to regular search
        performRegistrationSearch(q);
      }).withFailureHandler(err=>{
        // Error with QR lookup, fall back to regular search
        performRegistrationSearch(q);
      }).lookupByAggregate(q);
    } else {
      // Regular search - show lookup loading state
      const el=document.getElementById('result');
      el.classList.remove('hidden');
      el.innerHTML=`<div class="status">Looking up attendee...</div>`;
      performRegistrationSearch(q);
    }
  }
  
  function performRegistrationSearch(q) {
    google.script.run.withSuccessHandler(res=>{
      const cont=document.getElementById('registration_lk_results');
      if(!res || !res.items || res.items.length===0){ 
        cont.innerHTML='<div class="small">No matches.</div>'; 
        // Hide the loading state in result area
        document.getElementById('result').classList.add('hidden');
        return; 
      }
      cont.innerHTML='';
      res.items.forEach(it=>{
        const row=document.createElement('div');
        row.className='tr';
        // Show food as yes if city is not Bangalore or paid for food
        const city = String(it['City'] || '').trim().toLowerCase();
        const isNotBangalore = city !== 'bangalore' && city !== 'bengaluru' && city !== '';
        const paidForFood = (it['Paid for Food']||'').toString().toLowerCase()==='yes';
        const foodIncluded = (it['Food Included']||'').toString().toLowerCase()==='yes';
        const hasFood = isNotBangalore || paidForFood || foodIncluded;
        const isRegistered = (it['Registration']||'').toString().toLowerCase()==='yes';
        
        // Determine band color based on VVIP/VIP status
        const vvipValue = String(it['VVIPs'] || '').trim();
        const vipValue = String(it['VIPs'] || '').trim();
        let bandColor = 'blue'; // default
        let bandColorText = 'BLUE';
        if (vvipValue && vvipValue.toLowerCase() === 'yes') {
          bandColor = 'yellow';
          bandColorText = 'YELLOW';
        } else if (vipValue && vipValue.toLowerCase() === 'yes') {
          bandColor = 'green';
          bandColorText = 'GREEN';
        }
        
        row.innerHTML=`
          <div><b>${it.Name||'-'}</b><div class="small">${it['Type of Member']||''}</div></div>
          <div>${it.Phone||'-'}</div>
          <div>${it.Email||'-'}</div>
          <div>${it.City||'-'}</div>
          <div class="stack">
            <span class="band-${bandColor}">${bandColorText}</span>
            <button class="btn ${hasFood ? 'food-paid' : ''}" onclick="toggleFoodPayment(${it._row})" title="Toggle food payment status">
              Food ${hasFood ? '✓' : '○'}
            </button>
            <button class="btn ${isRegistered ? 'checked' : 'primary'}" onclick="toggleRegistrationFromLookup(${it._row}, 'registration', ${isRegistered})" title="Toggle registration">
              ${isRegistered ? '✓ Registered' : 'Register'}
            </button>
          </div>
        `;
        cont.appendChild(row);
      });
      // Hide the loading state in result area
      document.getElementById('result').classList.add('hidden');
    }).withFailureHandler(err=>{
      alert(err);
      // Hide the loading state in result area on error
      document.getElementById('result').classList.add('hidden');
    }).searchAttendees(q);
  }

  // Admin: Spot Registration (+ optional registration)
  function submitSpotReg(registerNowFlag){
    const att={
      'Name':sr_name.value,'Gender':sr_gender.value,'Age':sr_age.value,'Phone':sr_phone.value,
      'Email':sr_email.value,'Type of Member':sr_type.value,'City':sr_city.value,
      'State':sr_state.value,'Country':sr_country.value
    };
    
    // Validate required fields
    if (!att.Name || !att.Name.trim()) {
      alert('Please enter a name');
      return;
    }
    
    // Show loading state
    const box = document.getElementById('spot-result');
    box.classList.remove('hidden');
    box.innerHTML = '<div class="status">Processing...</div>';
    
    // Set a timeout to show error if no response
    const timeout = setTimeout(() => {
      box.innerHTML = '<div class="status bad">Request timed out. Please try again.</div>';
    }, 10000);
    
    google.script.run
      .withSuccessHandler(r=>{
        clearTimeout(timeout);
        console.log('Spot registration success:', r);
        
        if (!box) {
          console.error('spot-result element not found');
          return;
        }
        
        box.classList.remove('hidden');
        
        // Build status message
        let statusMessage = registerNowFlag ? 'Added & registered: ' : 'Added: ';
        statusMessage += (r.attendee && r.attendee.Name) ? r.attendee.Name : 'Unknown';
        
        box.innerHTML=`<div class="status ok">${statusMessage}</div>`;
        
        // Clear form fields
        ['sr_name','sr_gender','sr_age','sr_phone','sr_email','sr_type','sr_city','sr_state','sr_country'].forEach(id=>{ 
          const el=document.getElementById(id); 
          if(el) el.value=''; 
        });
        
        // Focus back to name field for next entry
        document.getElementById('sr_name').focus();
      })
      .withFailureHandler(err=>{
        clearTimeout(timeout);
        console.error('Spot registration error:', err);
        box.innerHTML = '<div class="status bad">Error: ' + err + '</div>';
      })
      .spotRegister(att, registerNowFlag);
  }

  // Clear spot registration form
  function clearSpotForm() {
    ['sr_name','sr_gender','sr_age','sr_phone','sr_email','sr_type','sr_city','sr_state','sr_country'].forEach(id=>{ 
      const el=document.getElementById(id); 
      if(el) el.value=''; 
    });
    document.getElementById('spot-result').classList.add('hidden');
    document.getElementById('sr_name').focus();
  }


  // Admin: Lookup + quick registration
  function lookup(){
    const q=(document.getElementById('lk_q').value||'').trim();
    if(!q){ document.getElementById('lk_results').innerHTML=''; return; }
    
    // First try QR code lookup if it looks like a QR code (contains VOA)
    if(q.includes('VOA')) {
      google.script.run.withSuccessHandler(resp=>{
        if(resp.status==='FOUND') {
          // Found via QR, show in results with registration status
          showLookupResults([resp.attendee]);
          return;
        }
        // QR not found, fall back to regular search
        performAdminSearch(q);
      }).withFailureHandler(err=>{
        // Error with QR lookup, fall back to regular search
        performAdminSearch(q);
      }).lookupByAggregate(q);
    } else {
      // Regular search
      performAdminSearch(q);
    }
  }
  
  function performAdminSearch(q) {
    google.script.run.withSuccessHandler(res=>{
      const cont=document.getElementById('lk_results');
      if(!res || !res.items || res.items.length===0){ cont.innerHTML='<div class="small">No matches.</div>'; return; }
      showLookupResults(res.items);
    }).withFailureHandler(err=>alert(err)).searchAttendees(q);
  }
  
  function showLookupResults(items) {
    const cont=document.getElementById('lk_results');
    cont.innerHTML='';
    items.forEach(it=>{
      const row=document.createElement('div');
      row.className='tr';
      // Show food as yes if city is not Bangalore or paid for food
      const city = String(it['City'] || '').trim().toLowerCase();
      const isNotBangalore = city !== 'bangalore' && city !== 'bengaluru' && city !== '';
      const paidForFood = (it['Paid for Food']||'').toString().toLowerCase()==='yes';
      const foodIncluded = (it['Food Included']||'').toString().toLowerCase()==='yes';
      const hasFood = isNotBangalore || paidForFood || foodIncluded;
      const isRegistered = (it['Registration']||'').toString().toLowerCase()==='yes';
      
      // Determine band color based on VVIP/VIP status
      const vvipValue = String(it['VVIPs'] || '').trim();
      const vipValue = String(it['VIPs'] || '').trim();
      let bandColor = 'blue'; // default
      let bandColorText = 'BLUE';
      if (vvipValue && vvipValue.toLowerCase() === 'yes') {
        bandColor = 'yellow';
        bandColorText = 'YELLOW';
      } else if (vipValue && vipValue.toLowerCase() === 'yes') {
        bandColor = 'green';
        bandColorText = 'GREEN';
      }
      
      row.innerHTML=`
        <div><b>${it.Name||'-'}</b><div class="small">${it['Type of Member']||''}</div></div>
        <div>${it.Phone||'-'}</div>
        <div>${it.Email||'-'}</div>
        <div>${it.City||'-'}</div>
        <div class="stack">
          <span class="band-${bandColor}">${bandColorText}</span>
          <button class="btn ${hasFood ? 'food-paid' : ''}" onclick="toggleFoodPayment(${it._row})" title="Toggle food payment status">
            Food ${hasFood ? '✓' : '○'}
          </button>
          <button class="btn ${isRegistered ? 'checked' : ''}" onclick="toggleRegistrationFromLookup(${it._row}, 'admin', ${isRegistered})" title="Toggle registration">
            ${isRegistered ? '✓ Registered' : 'Register'}
          </button>
        </div>
      `;
      cont.appendChild(row);
    });
  }
  function fillSpotFromLookup(row){
    google.script.run.withSuccessHandler(r=>{
      const a=r.attendee;
      sr_name.value=a.Name||''; sr_gender.value=a.Gender||''; sr_age.value=a.Age||'';
      sr_phone.value=a.Phone||''; sr_email.value=a.Email||''; sr_type.value=a['Type of Member']||''; 
      sr_city.value=a.City||''; sr_state.value=a.State||''; sr_country.value=a.Country||'';
    }).withFailureHandler(err=>alert(err)).getByRow(row);
  }
  
  function toggleRegistrationFromLookup(row, source, currentlyRegistered){
    // source can be 'registration' or 'admin'
    // Show appropriate loading message
    const el=document.getElementById('result');
    el.classList.remove('hidden');
    const loadingMessage = currentlyRegistered ? 'Undoing registration...' : 'Registering...';
    el.innerHTML=`<div class="status">${loadingMessage}</div>`;
    
    google.script.run.withSuccessHandler(r=>{
      console.log('toggleRegistration response:', r);
      const isRegistered = (r.attendee['Registration']||'').toString().toLowerCase()==='yes';
      console.log('isRegistered:', isRegistered, 'bandColor:', r.bandColor);
      
      if (source === 'registration') {
        // For registration tab, refresh the search and show message
        if(isRegistered) {
          // Show band color message when registered
          const bandColor = r.bandColor || 'blue';
          const bandColorText = bandColor === 'yellow' ? 'YELLOW' : (bandColor === 'green' ? 'GREEN' : 'BLUE');
          console.log('Showing band color:', bandColor, bandColorText);
          el.innerHTML=`
            <div class="status ok">
              <div style="margin-bottom:8px">✓ Registered: <strong>${r.attendee.Name}</strong></div>
              <div style="margin-bottom:8px">Please issue a <span class="band-${bandColor}">${bandColorText}</span> color band</div>
              <button class="btn ghost" onclick="undoRegistration('${r.attendee.Aggregate}')" style="margin-top:4px">Undo Registration</button>
            </div>
          `;
        } else {
          el.innerHTML=`<div class="status ok">Registration removed for: ${r.attendee.Name}</div>`;
        }
        registrationLookup(); // Refresh the search results
      } else {
        // For admin tab, just refresh the search
        lookup();
      }
    }).withFailureHandler(err=>{
      el.innerHTML=`<div class="status bad">Error: ${err}</div>`;
    }).toggleRegistration(row);
  }
  
  function toggleFoodPayment(row){
    google.script.run.withSuccessHandler(()=>lookup()).withFailureHandler(err=>alert(err)).togglePaidForFood(row,null);
  }

  // Stats refresh function
  function refreshStats(){
    // Show loading state
    document.getElementById("stats").innerHTML="<div class=\"status\">Loading stats...</div>";
    
    google.script.run
      .withSuccessHandler(res=>{
        const cont=document.getElementById("stats");
        if(res.status==="ERROR"){
          cont.innerHTML=`<div class="status bad">${res.message}</div>`;
          return;
        }
        cont.innerHTML=`
          <div class="field">
            <div class="kpi">${res.totalAttendees || 0}</div>
            <div class="small">Total</div>
          </div>
          <div class="field">
            <div class="kpi">${res.totalRegistered || 0}</div>
            <div class="small">Total Registered</div>
          </div>
          <div class="field">
            <div class="kpi">${res.registeredOutstation || 0}</div>
            <div class="small">Registered Outstation</div>
          </div>
          <div class="field">
            <div class="kpi">${res.registeredBangalore || 0}</div>
            <div class="small">Registered Bangalore</div>
          </div>
          <div class="field">
            <div class="kpi">${res.registeredPaidForFood || 0}</div>
            <div class="small">Registered Paid Food</div>
          </div>
          <div class="field">
            <div class="kpi">${res.vipsRegistered || 0}</div>
            <div class="small">Green Bands</div>
          </div>
          <div class="field">
            <div class="kpi">${res.vvipsRegistered || 0}</div>
            <div class="small">Yellow Bands</div>
          </div>
        `;
      })
      .withFailureHandler(err=>{
        document.getElementById("stats").innerHTML=`<div class="status bad">Error: ${err}</div>`;
      })
      .getRegistrationStats();
  }
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl+Enter or Cmd+Enter for Add and Register
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      if (document.getElementById('tab-spot').classList.contains('active')) {
        submitSpotReg(true);
      }
    }
    // Escape to clear form
    if (e.key === 'Escape') {
      if (document.getElementById('tab-spot').classList.contains('active')) {
        clearSpotForm();
      }
    }
  });

  // Init
  showTab('registration');
  
  // Auto-focus scan input on load
  setTimeout(() => {
    document.getElementById('scanInput').focus();
  }, 100);
</script>
</body>
</html>
